local replicatedStorage = game:GetService("ReplicatedStorage")
local damageEvent = replicatedStorage:WaitForChild("DA")

-- Table pour suivre l'état d'attaque des joueurs
local playerStatus = {}

damageEvent.OnServerEvent:Connect(function(player)
	local character = player.Character
	if not character then return end

	-- Vérifie si le joueur est déjà en train d'exécuter une attaque
	if playerStatus[player] then
		return -- Empêche la création d'une nouvelle hitbox si une attaque est déjà en cours
	end

	playerStatus[player] = true -- Indique que le joueur est en train d'attaquer

	local humanoid = character:FindFirstChild("Humanoid")
	local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
	local animator = humanoid and humanoid:FindFirstChildOfClass("Animator")

	if animator and humanoidRootPart then
		local animation = script:FindFirstChild("animation")
		if animation then
			-- Lancer l'animation
			local animationTrack = animator:LoadAnimation(animation)
			animationTrack:Play()

			-- Création de la hitbox
			local hitbox = Instance.new("Part")
			hitbox.Size = Vector3.new(5, 5, 5)  -- Taille de la hitbox
			hitbox.Transparency = 0.5  -- Transparence pour visualisation
			hitbox.Anchored = true  -- On fixe la hitbox en place
			hitbox.CanCollide = false  -- Pas de collision physique avec la hitbox
			hitbox.Parent = workspace  -- Ajout dans le workspace

			-- Positionnement de la hitbox devant le joueur
			hitbox.CFrame = humanoidRootPart.CFrame * CFrame.new(0, 0, -6)  -- Position ajustable selon la distance souhaitée

			-- Activer la hitbox lorsqu'elle touche quelque chose
			hitbox.Touched:Connect(function(hit)
				local hitCharacter = hit.Parent
				local hitHumanoid = hitCharacter:FindFirstChild("Humanoid")

				-- Vérifier que le humanoid touché n'est pas celui du joueur lui-même
				if hitHumanoid and hitHumanoid ~= humanoid then
					-- Infliger des dégâts à la cible touchée par la hitbox
					hitHumanoid:TakeDamage(10)
				end
			end)

			-- Destruction de la hitbox après la fin de l'animation
			animationTrack.Stopped:Connect(function()
				if hitbox then
					hitbox:Destroy()
				end
				playerStatus[player] = nil -- Libère le verrou, permettant une nouvelle attaque
			end)
		else
			warn("Animation non trouvée dans le script")
			playerStatus[player] = nil -- Libère le verrou en cas d'erreur
		end
	else
		warn("Animator ou HumanoidRootPart non trouvé pour le personnage du joueur")
		playerStatus[player] = nil -- Libère le verrou en cas d'erreur
	end
end)
